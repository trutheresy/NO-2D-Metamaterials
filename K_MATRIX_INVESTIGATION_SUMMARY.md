# K Matrix Investigation Summary

## Current Status

- **M matrix**: ✅ **FIXED** - Matches MATLAB after fixing `t=1.0` and `rho_min=1200`
- **K matrix**: ⚠️ **Still has issues** - values differ with many sign differences (8448/30274 entries)

## Key Findings

### 1. M Matrix Fix (Completed)
- Root cause: Default parameters `t=0.01` (Python) vs `t=1.0` (MATLAB) and `rho_min=400` vs `rho_min=1200`
- Solution: Changed defaults in `create_const_dict` and main function
- Result: M matrix now matches MATLAB (ratio ≈ 1.0, difference norm ≈ 0.03)

### 2. K Matrix Issues (In Progress)

**Observed differences:**
- Shapes match: (2178, 2178) ✅
- nnz counts match: 30348 ✅
- Value scales similar (same order of magnitude) ✅
- But values differ significantly:
  - Many sign differences (8448/30274 entries have opposite signs)
  - Diagonal entries show consistent ratio ~0.8901 (≈ 8/9)
  - Some entries have completely different values

**Root cause hypothesis:**
The sign differences and systematic ratio suggest that values are being placed in wrong positions in the global matrix. This is likely due to:

1. **MATLAB's transpose behavior**: 
   - MATLAB: `AllLEle = get_element_stiffness_VEC(E(:),nu(:),t)'` then `value_K = AllLEle(:)`
   - This transposes from (N_ele, 64) to (64, N_ele), then flattens column-wise
   - This **interleaves** element values: value_K[i] corresponds to element (i mod N_ele)
   
2. **Index generation must match value ordering**:
   - The `row_idxs` and `col_idxs` generated by `kron` and `reshape` must match the interleaved value order
   - If values are interleaved but indices are sequential (or vice versa), values end up in wrong positions

3. **Python's current behavior**:
   - Python: `AllLEle.flatten()` (row-major) = sequential: all of element 0, then all of element 1, etc.
   - This is different from MATLAB's interleaved order

## Next Steps

1. **Verify MATLAB's get_element_stiffness_VEC output format**:
   - Does it return (N_ele, 64) or (64, N_ele)?
   - How does the transpose affect the shape?

2. **Fix Python to match MATLAB's interleaving**:
   - If MATLAB interleaves values, Python must do the same
   - Need to ensure `value_K` has elements interleaved to match index pattern

3. **Verify index-value alignment**:
   - After fixing value interleaving, verify that indices match values correctly
   - Test with a small case to verify correctness

## Files Modified

1. `2d-dispersion-py/plot_dispersion_infer_eigenfrequencies.py`:
   - Changed `t=0.01` → `t=1.0`
   - Changed `rho_min=400` → `rho_min=1200`

2. `2d-dispersion-py/system_matrices_vec.py`:
   - Fixed E overflow using float64 intermediate calculations

## Test Files Created

- `test_K_matrix_difference_pattern.py`: Analyzes difference patterns
- `test_small_matrix_comparison.py`: Compares specific entries
- `test_index_value_alignment.py`: Tests index generation
- `test_python_match_matlab_flattening.py`: Tests flattening behavior
- `test_element_matrix_flattening.py`: Tests element matrix flattening

